#!/usr/bin/env bash
# Flow Developer Script - Thin wrapper around Flow CLI and project tools
# Usage: ./dev [command]

set -eo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Print with color
print_header() {
    echo -e "\n${BOLD}${BLUE}═══════════════════════════════════════${NC}"
    echo -e "${BOLD}${BLUE}  Flow Framework - Developer Tools${NC}"
    echo -e "${BOLD}${BLUE}═══════════════════════════════════════${NC}\n"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${CYAN}→${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

# Command: setup
cmd_setup() {
    print_info "Installing dependencies..."
    uv sync --all-extras --dev
    print_success "Dependencies installed!"

    if [ ! -f ".git/hooks/pre-commit" ]; then
        print_info "Installing pre-commit hooks..."
        uv run pre-commit install
        print_success "Pre-commit hooks installed!"
    fi
}

# Command: test
cmd_test() {
    local test_args="${*:---v}"
    print_info "Running tests..."
    # shellcheck disable=SC2086  # Word splitting intentional for test args
    uv run pytest $test_args
}

# Command: test with coverage
cmd_test_cov() {
    print_info "Running tests with coverage..."
    uv run pytest --cov=src/flow --cov-report=term-missing "$@"
}

# Command: test excluding E2E
cmd_test_fast() {
    print_info "Running tests (excluding E2E)..."
    uv run pytest tests/ --ignore=tests/e2e -v "$@"
}

# Command: gatekeeper tests
cmd_test_gate() {
    print_info "Running gatekeeper tests..."
    uv run pytest tests/gatekeepers/ -v -m gatekeeper "$@"
}

# Command: lint
cmd_lint() {
    print_info "Running linter..."
    uv run ruff check --fix src/ tests/
    print_success "Lint complete!"

    print_info "Running formatter..."
    uv run ruff format src/ tests/
    print_success "Format complete!"

    print_info "Running type checker..."
    uv run mypy src/ tests/
    print_success "Type check complete!"
}

# Command: pre-commit (all checks)
cmd_check() {
    print_info "Running all pre-commit checks..."
    uv run pre-commit run --all-files
}

# Command: help
cmd_help() {
    echo -e "${BOLD}Usage:${NC} ./dev [command] [options]"
    echo ""
    echo -e "${BOLD}Setup Commands:${NC}"
    echo -e "  ${CYAN}setup${NC}       Install dependencies and pre-commit hooks"
    echo ""
    echo -e "${BOLD}Flow CLI (delegated to 'uv run flow'):${NC}"
    echo -e "  ${CYAN}dev${NC}         Start dev server (alias: uv run flow dev)"
    echo -e "  ${CYAN}build${NC}       Build for production (alias: uv run flow build)"
    echo -e "  ${CYAN}new${NC}         Create new project (alias: uv run flow new)"
    echo ""
    echo -e "${BOLD}Testing Commands:${NC}"
    echo -e "  ${CYAN}test${NC}        Run all tests (pass args: ./dev test -k 'test_name')"
    echo -e "  ${CYAN}test:fast${NC}   Run tests excluding E2E (faster iteration)"
    echo -e "  ${CYAN}test:cov${NC}    Run tests with coverage report"
    echo -e "  ${CYAN}test:gate${NC}   Run gatekeeper performance & security tests"
    echo ""
    echo -e "${BOLD}Code Quality:${NC}"
    echo -e "  ${CYAN}lint${NC}        Run linter, formatter, and type checker"
    echo -e "  ${CYAN}check${NC}       Run all pre-commit checks"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  ./dev setup              # Install dependencies"
    echo "  ./dev test:fast          # Quick test run"
    echo "  ./dev test -k signal     # Run tests matching 'signal'"
    echo "  ./dev lint               # Format and type check"
    echo ""
    echo "  uv run flow dev          # Start dev server (Flow CLI)"
    echo "  uv run flow build        # Build for production"
    echo "  uv run flow new myapp    # Create new project"
}

# Main entry point
main() {
    # Check if uv is installed
    if ! command -v uv &> /dev/null; then
        print_error "uv is not installed. Install it with:"
        echo "  curl -LsSf https://astral.sh/uv/install.sh | sh"
        exit 1
    fi

    # Parse command
    local cmd="${1:-}"

    case "$cmd" in
        "")
            cmd_help
            ;;
        setup)
            cmd_setup
            ;;
        test)
            shift
            cmd_test "$@"
            ;;
        test:fast)
            shift
            cmd_test_fast "$@"
            ;;
        test:cov)
            shift
            cmd_test_cov "$@"
            ;;
        test:gate)
            shift
            cmd_test_gate "$@"
            ;;
        lint)
            cmd_lint
            ;;
        check)
            cmd_check
            ;;
        # Delegate Flow CLI commands
        dev|build|new)
            print_info "Delegating to Flow CLI..."
            uv run flow "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            print_error "Unknown command: $cmd"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
