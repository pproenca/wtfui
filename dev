#!/usr/bin/env bash
# Flow Developer Script - Interactive development helper
# Usage: ./dev [command]

set -eo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Print with color
print_header() {
    echo -e "\n${BOLD}${BLUE}═══════════════════════════════════════${NC}"
    echo -e "${BOLD}${BLUE}  Flow Framework - Developer Tools${NC}"
    echo -e "${BOLD}${BLUE}═══════════════════════════════════════${NC}\n"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${CYAN}→${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

# Command: setup
cmd_setup() {
    print_info "Installing dependencies..."
    uv sync --extra dev
    print_success "Dependencies installed!"

    if [ ! -f ".git/hooks/pre-commit" ]; then
        print_info "Installing pre-commit hooks..."
        uv run pre-commit install
        print_success "Pre-commit hooks installed!"
    fi
}

# Command: start (dev server)
cmd_start() {
    local app_path="${1:-examples.todo.app:app}"
    print_info "Starting dev server..."
    echo -e "${CYAN}   App: ${app_path}${NC}"
    echo -e "${CYAN}   URL: http://127.0.0.1:8000${NC}\n"
    uv run flow dev "$app_path"
}

# Command: test
cmd_test() {
    local test_args="${*:---v}"
    print_info "Running tests..."
    # shellcheck disable=SC2086  # Word splitting intentional for test args
    uv run pytest $test_args
}

# Command: test with coverage
cmd_test_cov() {
    print_info "Running tests with coverage..."
    uv run pytest --cov=src/flow --cov-report=term-missing "$@"
}

# Command: build
cmd_build() {
    local app_path="${1:-examples.todo.app:app}"
    local output="${2:-dist}"
    print_info "Building for production..."
    uv run flow build "$app_path" -o "$output"
}

# Command: lint
cmd_lint() {
    print_info "Running linter..."
    uv run ruff check --fix src/ tests/
    print_success "Lint complete!"

    print_info "Running formatter..."
    uv run ruff format src/ tests/
    print_success "Format complete!"

    print_info "Running type checker..."
    uv run mypy src/ tests/
    print_success "Type check complete!"
}

# Command: new project
cmd_new() {
    local name="$1"
    if [ -z "$name" ]; then
        echo -n "Project name: "
        read -r name
    fi

    if [ -z "$name" ]; then
        print_error "Project name is required"
        exit 1
    fi

    print_info "Creating new Flow project: $name"
    uv run flow new "$name"
}

# Command: help
cmd_help() {
    echo -e "${BOLD}Usage:${NC} ./dev [command] [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo -e "  ${CYAN}setup${NC}      Install dependencies and pre-commit hooks"
    echo -e "  ${CYAN}start${NC}      Start the development server"
    echo -e "  ${CYAN}test${NC}       Run tests (pass args: ./dev test -k 'test_name')"
    echo -e "  ${CYAN}test:cov${NC}   Run tests with coverage report"
    echo -e "  ${CYAN}build${NC}      Build for production"
    echo -e "  ${CYAN}lint${NC}       Run linter, formatter, and type checker"
    echo -e "  ${CYAN}new${NC}        Create a new Flow project"
    echo -e "  ${CYAN}help${NC}       Show this help message"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  ./dev                    # Interactive menu"
    echo "  ./dev setup              # Install dependencies"
    echo "  ./dev start myapp:app    # Start with specific app"
    echo "  ./dev test -k signal     # Run tests matching 'signal'"
    echo "  ./dev new my-project     # Create new project"
}

# Interactive menu
show_menu() {
    print_header

    echo -e "${BOLD}What would you like to do?${NC}\n"

    local options=(
        "Setup      - Install dependencies"
        "Start      - Start dev server"
        "Test       - Run tests"
        "Test+Cov   - Run tests with coverage"
        "Build      - Build for production"
        "Lint       - Lint and format code"
        "New        - Create new project"
        "Help       - Show help"
        "Quit"
    )

    PS3=$'\n\033[0;36mEnter choice [1-'"${#options[@]}"$']:\033[0m '

    select opt in "${options[@]}"; do
        case $opt in
            "Setup"*)
                cmd_setup
                break
                ;;
            "Start"*)
                echo -n "App path (Enter for examples.todo.app:app): "
                read -r app_path
                cmd_start "${app_path:-examples.todo.app:app}"
                break
                ;;
            "Test"*)
                echo -n "Test arguments (Enter for all): "
                read -r test_args
                # shellcheck disable=SC2086  # Word splitting intentional for test args
                cmd_test $test_args
                break
                ;;
            "Test+Cov"*)
                cmd_test_cov
                break
                ;;
            "Build"*)
                echo -n "App path (Enter for examples.todo.app:app): "
                read -r app_path
                cmd_build "${app_path:-examples.todo.app:app}"
                break
                ;;
            "Lint"*)
                cmd_lint
                break
                ;;
            "New"*)
                cmd_new
                break
                ;;
            "Help"*)
                cmd_help
                break
                ;;
            "Quit")
                echo -e "\n${GREEN}Goodbye!${NC}"
                exit 0
                ;;
            *)
                print_error "Invalid option. Please try again."
                ;;
        esac
    done
}

# Main entry point
main() {
    # Check if uv is installed
    if ! command -v uv &> /dev/null; then
        print_error "uv is not installed. Install it with:"
        echo "  curl -LsSf https://astral.sh/uv/install.sh | sh"
        exit 1
    fi

    # Parse command
    local cmd="${1:-}"

    case "$cmd" in
        "")
            show_menu
            ;;
        setup)
            cmd_setup
            ;;
        start)
            shift
            cmd_start "$@"
            ;;
        test)
            shift
            cmd_test "$@"
            ;;
        test:cov)
            shift
            cmd_test_cov "$@"
            ;;
        build)
            shift
            cmd_build "$@"
            ;;
        lint)
            cmd_lint
            ;;
        new)
            shift
            cmd_new "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            print_error "Unknown command: $cmd"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
